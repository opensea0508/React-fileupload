"use strict";var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var o in i){if(Object.prototype.hasOwnProperty.call(i,o)){e[o]=i[o]}}}return e};var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol==="function"&&e.constructor===Symbol?"symbol":typeof e};var React=require("react");var emptyFunction=function e(){};var currentIEID=0;var IEFormGroup=[true];var xhrList=[];var currentXHRID=0;var PT=React.PropTypes;var FileUpload=React.createClass({displayName:"FileUpload",propTypes:{options:PT.shape({baseUrl:PT.string.isRequired,param:PT.oneOfType([PT.object,PT.func]),dataType:PT.string,chooseAndUpload:PT.bool,paramAddToField:PT.oneOfType([PT.object,PT.func]),wrapperDisplay:PT.string,timeout:PT.number,accept:PT.string,multiple:PT.bool,numberLimit:PT.oneOfType([PT.number,PT.func]),fileFieldName:PT.oneOfType([PT.string,PT.func]),withCredentials:PT.bool,requestHeaders:PT.object,tag:PT.string,userAgent:PT.string,disabledIEChoose:PT.oneOfType([PT.bool,PT.func]),_withoutFileUpload:PT.bool,filesToUpload:PT.arrayOf(PT.object),textBeforeFiles:PT.bool,beforeChoose:PT.func,chooseFile:PT.func,beforeUpload:PT.func,doUpload:PT.func,uploading:PT.func,uploadSuccess:PT.func,uploadError:PT.func,uploadFail:PT.func,onabort:PT.func}).isRequired,style:PT.object,className:PT.string},_updateProps:function e(t){var i=this;this.isIE=!(this.checkIE()<0||this.checkIE()>=10);var o=t.options;this.baseUrl=o.baseUrl;this.param=o.param;this.chooseAndUpload=o.chooseAndUpload||false;this.paramAddToField=o.paramAddToField||undefined;this.dataType="json";o.dataType&&o.dataType.toLowerCase()=="text"&&(this.dataType="text");this.wrapperDisplay=o.wrapperDisplay||"inline-block";this.timeout=typeof o.timeout=="number"&&o.timeout>0?o.timeout:0;this.accept=o.accept||"";this.multiple=o.multiple||false;this.numberLimit=o.numberLimit||false;this.fileFieldName=o.fileFieldName||false;this.withCredentials=o.withCredentials||false;this.requestHeaders=o.requestHeaders||false;this.beforeChoose=o.beforeChoose||emptyFunction;this.chooseFile=o.chooseFile||emptyFunction;this.beforeUpload=o.beforeUpload||emptyFunction;this.doUpload=o.doUpload||emptyFunction;this.uploading=o.uploading||emptyFunction;this.uploadSuccess=o.uploadSuccess||emptyFunction;this.uploadError=o.uploadError||emptyFunction;this.uploadFail=o.uploadFail||emptyFunction;this.onabort=o.onabort||emptyFunction;this.files=o.files||this.files||false;this.disabledIEChoose=o.disabledIEChoose||false;this._withoutFileUpload=o._withoutFileUpload||false;this.filesToUpload=o.filesToUpload||[];this.textBeforeFiles=o.textBeforeFiles||false;if(this.filesToUpload.length&&!this.isIE){this.filesToUpload.forEach(function(e){i.files=[e];i.commonUpload()})}var a=void 0,s=void 0,r=0;var n=[],l=[],p=[];if(this.chooseAndUpload){React.Children.forEach(t.children,function(e){if(e&&e.ref=="chooseAndUpload"){a=e;r++}else{r==0?n.push(e):r==1?l.push(e):""}})}else{React.Children.forEach(t.children,function(e){if(e&&e.ref=="chooseBtn"){a=e;r++}else if(e&&e.ref=="uploadBtn"){s=e;r++}else{r==0?n.push(e):r==1?l.push(e):p.push(e)}})}this.setState({chooseBtn:a,uploadBtn:s,before:n,middle:l,after:p})},commonChooseFile:function e(){var t=this.beforeChoose();if(t!=true&&t!=undefined)return;this.refs["ajax_upload_file_input"].click()},commonChange:function e(t){var i=void 0;t.dataTransfer?i=t.dataTransfer.files:t.target?i=t.target.files:"";var o=typeof this.numberLimit==="function"?this.numberLimit():this.numberLimit;if(this.multiple&&o&&i.length>o){var a={};for(var s=0;s<o;s++){a[s]=i[s]}a.length=o;i=a}this.files=i;this.chooseFile(i);this.chooseAndUpload&&this.commonUpload()},commonUpload:function e(){var t=this;var i=this.files.length&&this.files[0].mill||(new Date).getTime();var o=this.beforeUpload(this.files,i);if(o!=true&&o!=undefined&&(typeof o==="undefined"?"undefined":_typeof(o))!="object"){this.refs["ajax_upload_file_input"].value="";return}if(!this.files)return;if(!this.baseUrl)throw new Error("baseUrl missing in options");var a={};var s=new FormData;if(this.textBeforeFiles){s=this.appendFieldsToFormData(s)}if(!this._withoutFileUpload){(function(){var e=_typeof(t.fileFieldName);Object.keys(t.files).forEach(function(i){if(i=="length")return;if(e=="function"){var o=t.files[i];var a=t.fileFieldName(o);s.append(a,o)}else if(e=="string"){var r=t.files[i];s.append(t.fileFieldName,r)}else{var n=t.files[i];s.append(n.name,n)}})})()}if(!this.textBeforeFiles){s=this.appendFieldsToFormData(s)}var r=this.baseUrl;var n=typeof this.param==="function"?this.param(this.files):this.param;var l="";if(n){(function(){var e=[];n["_"]=i;Object.keys(n).forEach(function(t){return e.push(t+"="+n[t])});l="?"+e.join("&")})()}var p=r+l;var u=new XMLHttpRequest;u.open("POST",p,true);u.withCredentials=this.withCredentials;var d=this.requestHeaders;d&&Object.keys(d).forEach(function(e){return u.setRequestHeader(e,d[e])});if(this.timeout){u.timeout=this.timeout;u.ontimeout=function(){t.uploadError({type:"TIMEOUTERROR",message:"timeout"});a.isTimeout=false};a.isTimeout=false;setTimeout(function(){a.isTimeout=true},this.timeout)}u.onreadystatechange=function(){try{if(u.readyState==4&&u.status>=200&&u.status<400){var e=t.dataType=="json"?JSON.parse(u.responseText):u.responseText;t.uploadSuccess(e)}else if(u.readyState==4){var i=t.dataType=="json"?JSON.parse(u.responseText):u.responseText;t.uploadFail(i)}}catch(e){!a.isTimeout&&t.uploadError({type:"FINISHERROR",message:e.message})}};u.onerror=function(){try{var e=t.dataType=="json"?JSON.parse(u.responseText):u.responseText;t.uploadError({type:"XHRERROR",message:e})}catch(e){t.uploadError({type:"XHRERROR",message:e.message})}};u.onprogress=u.upload.onprogress=function(e){t.uploading(e,i)};this._withoutFileUpload?u.send(null):u.send(s);xhrList.push(u);var f=xhrList.length-1;currentXHRID=f;u.onabort=function(){return t.onabort(i,f)};this.doUpload(this.files,i,currentXHRID);this.refs["ajax_upload_file_input"].value=""},appendFieldsToFormData:function e(t){var i=typeof this.paramAddToField=="function"?this.paramAddToField():this.paramAddToField;i&&Object.keys(i).map(function(e){return t.append(e,i[e])});return t},IEBeforeChoose:function e(t){var i=this.beforeChoose();i!=true&&i!=undefined&&t.preventDefault()},IEChooseFile:function e(t){this.fileName=t.target.value.substring(t.target.value.lastIndexOf("\\")+1);this.chooseFile(this.fileName);this.chooseAndUpload&&this.IEUpload()!==false&&document.getElementById("ajax_upload_file_form_"+this.IETag+currentIEID).submit();t.target.blur()},IEUpload:function e(t){var i=this;var o=(new Date).getTime();var a=this.beforeUpload(this.fileName,o);if(!this.fileName||a!=true&&a!=undefined){t&&t.preventDefault();return false}var s=this;var r=this.baseUrl;var n=typeof this.param==="function"?this.param(this.fileName):this.param;var l="";if(n){var p=[];n["_"]=o;n["ie"]===undefined&&(n["ie"]="true");for(var u in n){if(n[u]!=undefined)p.push(u+"="+n[u])}l="?"+p.join("&")}var d=r+l;document.getElementById("ajax_upload_file_form_"+this.IETag+currentIEID).setAttribute("action",d);var f=this.fakeProgress();var h=0,c=0;var m=setInterval(function(){h=f(h);i.uploading({loaded:h,total:100},o);++c>=150&&clearInterval(m)},200);var v=currentIEID;window.attachEvent?document.getElementById("ajax_upload_file_frame_"+this.IETag+v).attachEvent("onload",y):document.getElementById("ajax_upload_file_frame_"+this.IETag+v).addEventListener("load",y);function y(){clearInterval(m);try{s.uploadSuccess(s.IECallback(s.dataType,v))}catch(e){s.uploadError(e)}finally{var e=document.getElementById("ajax_upload_hidden_input_"+s.IETag+v);e.outerHTML=e.outerHTML}}this.doUpload(this.fileName,o);IEFormGroup[currentIEID]=false},IECallback:function IECallback(dataType,frameId){IEFormGroup[frameId]=true;var frame=document.getElementById("ajax_upload_file_frame_"+this.IETag+frameId);var resp={};var content=frame.contentWindow?frame.contentWindow.document.body:frame.contentDocument.document.body;if(!content)throw new Error("Your browser does not support async upload");try{resp.responseText=content.innerHTML||"null innerHTML";resp.json=JSON?JSON.parse(resp.responseText):eval("("+resp.responseText+")")}catch(e){if(e.message&&e.message.indexOf("Unexpected token")>=0){if(resp.responseText.indexOf("{")>=0){var msg=resp.responseText.substring(resp.responseText.indexOf("{"),resp.responseText.lastIndexOf("}")+1);return JSON?JSON.parse(msg):eval("("+msg+")")}return{type:"FINISHERROR",message:e.message}}throw e}return dataType=="json"?resp.json:resp.responseText},forwardChoose:function e(){if(this.isIE)return false;this.commonChooseFile()},fowardRemoveFile:function e(t){this.files=t(this.files)},filesToUpload:function e(t){if(this.isIE)return;this.files=t;this.commonUpload()},abort:function e(t){t===undefined?xhrList[currentXHRID].abort():xhrList[t].abort()},checkIE:function e(){var t=this.userAgent;var i=t.indexOf("MSIE");if(i<0)return-1;return parseFloat(t.substring(i+5,t.indexOf(";",i)))},fakeProgress:function e(){var t=6;var i=.3,o=98,a=.2;return function(e){var s=e;if(s>=o)return s;s+=t;t=t-i;t<a&&(t=a);return s}},getUserAgent:function e(){var t=this.props.options.userAgent;var i=typeof navigator!=="undefined";if(!i&&!t){throw new Error("`options.userAgent` must be set rendering react-fileuploader in situations when `navigator` is not defined in the global namespace. (on the server, for example)")}return i?navigator.userAgent:t},getInitialState:function e(){return{chooseBtn:{},uploadBtn:{},before:[],middle:[],after:[]}},componentWillMount:function e(){this.userAgent=this.getUserAgent();this.isIE=!(this.checkIE()<0||this.checkIE()>=10);var t=this.props.options&&this.props.options.tag;this.IETag=t?t+"_":"";this._updateProps(this.props)},componentDidMount:function e(){},componentWillReceiveProps:function e(t){this._updateProps(t)},render:function e(){return this._packRender()},_packRender:function e(){var t="";if(this.isIE){t=this._multiIEForm()}else{var i={accept:this.accept,multiple:this.multiple};t=React.createElement("div",{className:this.props.className,style:this.props.style},this.state.before,React.createElement("div",{onClick:this.commonChooseFile,style:{overflow:"hidden",postion:"relative",display:this.wrapperDisplay}},this.state.chooseBtn),this.state.middle,React.createElement("div",{onClick:this.commonUpload,style:{overflow:"hidden",postion:"relative",display:this.chooseAndUpload?"none":this.wrapperDisplay}},this.state.uploadBtn),this.state.after,React.createElement("input",_extends({type:"file",name:"ajax_upload_file_input",ref:"ajax_upload_file_input",style:{display:"none"},onChange:this.commonChange},i)))}return t},_multiIEForm:function e(){var t=[];var i=false;var o=typeof this.disabledIEChoose==="function"?this.disabledIEChoose():this.disabledIEChoose;for(var a=0;a<IEFormGroup.length;a++){s.call(this,t,a);if(IEFormGroup[a]&&!i){i=true;currentIEID=a}a==IEFormGroup.length-1&&!i&&IEFormGroup.push(true)}return React.createElement("div",{className:this.props.className,style:this.props.style,id:"react-file-uploader"},t);function s(e,t){if(IEFormGroup[t]&&i)return;var a=IEFormGroup[t];var s={position:"absolute",left:"-30px",top:0,zIndex:"50",fontSize:"80px",width:"200px",opacity:0,filter:"alpha(opacity=0)"};var r={accept:this.accept,disabled:o};var n=React.createElement("input",_extends({type:"file",name:"ajax_upload_hidden_input_"+t,id:"ajax_upload_hidden_input_"+t,ref:"ajax_upload_hidden_input_"+t,onChange:this.IEChooseFile,onClick:this.IEBeforeChoose,style:s},r));t=""+this.IETag+t;e.push(React.createElement("form",{id:"ajax_upload_file_form_"+t,method:"post",target:"ajax_upload_file_frame_"+t,key:"ajax_upload_file_form_"+t,encType:"multipart/form-data",ref:"form_"+t,onSubmit:this.IEUpload,style:{display:a?"block":"none"}},this.state.before,React.createElement("div",{style:{overflow:"hidden",position:"relative",display:"inline-block"}},this.state.chooseBtn,n),this.state.middle,React.createElement("div",{style:{overflow:"hidden",position:"relative",display:this.chooseAndUpload?"none":this.wrapperDisplay}},this.state.uploadBtn,React.createElement("input",{type:"submit",style:{position:"absolute",left:0,top:0,fontSize:"50px",width:"200px",opacity:0}})),this.state.after));e.push(React.createElement("iframe",{id:"ajax_upload_file_frame_"+t,name:"ajax_upload_file_frame_"+t,key:"ajax_upload_file_frame_"+t,className:"ajax_upload_file_frame",style:{display:"none",width:0,height:0,margin:0,border:0}}))}}});module.exports=FileUpload;